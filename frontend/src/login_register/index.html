<!-- Trang Đăng Ký và Đăng Nhập - Sử dụng Tailwind CSS -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Ký & Đăng Nhập</title>
    <!-- Tải Tailwind CSS cho giao diện hiện đại -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thiết lập font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        /* Hiệu ứng mờ cho nút khi đang tải */
        .loading {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body>

<!-- Khối chính (Main Card) -->
<div id="auth-container" class="bg-white p-8 md:p-12 shadow-2xl rounded-xl w-full max-w-md transition-all duration-500 ease-in-out">
    
    <!-- Phần Hiển thị Thông báo (Dùng để thay thế alert/confirm) -->
    <div id="messageBox" class="hidden p-3 mb-4 rounded-lg text-sm" role="alert"></div>

    <!-- 1. FORM ĐĂNG KÝ -->
    <form id="registerForm" class="space-y-6">
        <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">Đăng Ký Tài Khoản</h2>
        
        <div>
            <label for="regEmail" class="block text-sm font-medium text-gray-700">Địa chỉ Email</label>
            <input type="email" id="regEmail" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="vd: ban@example.com">
            <p id="regEmailError" class="text-red-500 text-xs mt-1 hidden">Email không hợp lệ.</p>
        </div>

        <div>
            <label for="regPassword" class="block text-sm font-medium text-gray-700">Mật khẩu</label>
            <input type="password" id="regPassword" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Ít nhất 6 ký tự">
            <p id="regPasswordError" class="text-red-500 text-xs mt-1 hidden">Mật khẩu phải có ít nhất 6 ký tự.</p>
        </div>

        <div>
            <label for="regConfirmPassword" class="block text-sm font-medium text-gray-700">Xác nhận Mật khẩu</label>
            <input type="password" id="regConfirmPassword" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Nhập lại mật khẩu">
            <p id="regConfirmPasswordError" class="text-red-500 text-xs mt-1 hidden">Xác nhận mật khẩu không khớp.</p>
        </div>

        <button type="submit" id="registerButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
            Đăng Ký
        </button>

        <p class="mt-4 text-center text-sm text-gray-600">
            Bạn đã có tài khoản? 
            <a href="#" id="showLogin" class="font-medium text-indigo-600 hover:text-indigo-500 hover:underline">Đăng nhập ngay</a>
        </p>
    </form>

    <!-- 2. FORM ĐĂNG NHẬP (Mặc định ẩn) -->
    <form id="loginForm" class="space-y-6 hidden">
        <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">Đăng Nhập</h2>
        
        <div>
            <label for="loginEmail" class="block text-sm font-medium text-gray-700">Địa chỉ Email</label>
            <input type="email" id="loginEmail" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="vd: ban@example.com">
        </div>

        <div>
            <label for="loginPassword" class="block text-sm font-medium text-gray-700">Mật khẩu</label>
            <input type="password" id="loginPassword" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Mật khẩu của bạn">
        </div>

        <button type="submit" id="loginButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
            Đăng Nhập
        </button>

        <p class="mt-4 text-center text-sm">
            <a href="#" id="showForgotPassword" class="font-medium text-blue-600 hover:text-blue-500 hover:underline">Quên mật khẩu?</a>
        </p>
        <p class="mt-4 text-center text-sm text-gray-600">
            Bạn chưa có tài khoản?
            <a href="#" id="showRegister" class="font-medium text-blue-600 hover:text-blue-500 hover:underline">Đăng ký ngay</a>
        </p>
    </form>
    
    <!-- 3. FORM QUÊN MẬT KHẨU (Mặc định ẩn) -->
    <form id="forgotPasswordForm" class="space-y-6 hidden">
        <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">Quên Mật Khẩu</h2>
        <p class="text-center text-gray-600 text-sm">Nhập địa chỉ email đã đăng ký của bạn. Chúng tôi sẽ gửi một liên kết để đặt lại mật khẩu.</p>
        
        <div>
            <label for="resetEmail" class="block text-sm font-medium text-gray-700">Địa chỉ Email</label>
            <input type="email" id="resetEmail" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500 transition duration-150" placeholder="Email của bạn">
        </div>

        <button type="submit" id="resetPasswordButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
            Gửi Yêu Cầu Đặt Lại Mật Khẩu
        </button>

        <p class="mt-4 text-center text-sm text-gray-600">
            <a href="#" id="backToLogin" class="font-medium text-gray-600 hover:text-gray-900 hover:underline">Quay lại Đăng nhập</a>
        </p>
    </form>
</div>

<!-- Khối JavaScript -->
<script type="module">
    // Cài đặt Firebase 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Khai báo biến toàn cục (sử dụng giá trị mặc định nếu không tồn tại trong môi trường)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Khởi tạo Firebase
    let app, db, auth;
    let userId = null; 
    let isFirebaseReady = false;

    if (Object.keys(firebaseConfig).length > 0) {
        setLogLevel('debug');
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        isFirebaseReady = true;

        // Xử lý xác thực ban đầu
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(error => {
                console.error("Lỗi xác thực bằng token tùy chỉnh:", error);
                signInAnonymously(auth); // Thử đăng nhập ẩn danh nếu token lỗi
            });
        } else {
            signInAnonymously(auth);
        }

        // Lắng nghe trạng thái xác thực
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                console.log("Người dùng đã xác thực. UID:", userId);
                // Hiển thị ID người dùng cho mục đích debugging/multi-user
                let userDisplay = document.getElementById('user-id-display');
                if (!userDisplay) {
                     document.getElementById('auth-container').insertAdjacentHTML('beforeend', `<p id="user-id-display" class="mt-4 text-xs text-center text-gray-400">UserID: ${userId}</p>`);
                }
            } else {
                userId = null;
                console.log("Chưa có người dùng nào được xác thực.");
            }
        });
    } else {
        console.warn("Cảnh báo: Firebase Config không được cung cấp. Các chức năng Auth/DB sẽ chỉ là mô phỏng.");
    }
    // --- END FIREBASE SETUP ---

    // Lấy tham chiếu đến các form và phần tử
    const registerForm = document.getElementById('registerForm');
    const loginForm = document.getElementById('loginForm');
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    
    // Lấy tham chiếu đến các nút/link chuyển đổi
    const showLoginLink = document.getElementById('showLogin');
    const showRegisterLink = document.getElementById('showRegister');
    const showForgotPasswordLink = document.getElementById('showForgotPassword');
    const backToLoginLink = document.getElementById('backToLogin');
    
    // Lấy tham chiếu đến các nút submit và box thông báo
    const registerButton = document.getElementById('registerButton');
    const loginButton = document.getElementById('loginButton');
    const resetPasswordButton = document.getElementById('resetPasswordButton');
    const messageBox = document.getElementById('messageBox');
    
    // Lấy tham chiếu đến các trường input và error messages
    const regEmailInput = document.getElementById('regEmail');
    const regPasswordInput = document.getElementById('regPassword');
    const regConfirmPasswordInput = document.getElementById('regConfirmPassword');
    const regEmailError = document.getElementById('regEmailError');
    const regPasswordError = document.getElementById('regPasswordError');
    const regConfirmPasswordError = document.getElementById('regConfirmPasswordError');
    const resetEmailInput = document.getElementById('resetEmail');

    /**
     * Hàm hiển thị thông báo cho người dùng
     * @param {string} message Nội dung thông báo
     * @param {string} type Loại thông báo ('success', 'error', 'info')
     */
    function showMessage(message, type = 'info') {
        let bgColor = '';
        let textColor = '';
        
        switch (type) {
            case 'success':
                bgColor = 'bg-green-100';
                textColor = 'text-green-800';
                break;
            case 'error':
                bgColor = 'bg-red-100';
                textColor = 'text-red-800';
                break;
            case 'info':
            default:
                bgColor = 'bg-blue-100';
                textColor = 'text-blue-800';
                break;
        }

        messageBox.className = `p-3 mb-4 rounded-lg text-sm ${bgColor} ${textColor}`;
        messageBox.textContent = message;
        messageBox.classList.remove('hidden');
        
        // Tự động ẩn sau 5 giây
        setTimeout(() => {
            messageBox.classList.add('hidden');
        }, 5000);
    }

    /**
     * Đặt trạng thái loading cho nút
     * @param {HTMLElement} button Nút cần đặt trạng thái
     * @param {boolean} isLoading Trạng thái (true/false)
     * @param {string} originalText Nội dung ban đầu của nút
     */
    function setLoading(button, isLoading, originalText) {
        if (isLoading) {
            button.disabled = true;
            button.classList.add('loading');
            button.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Đang xử lý...`;
        } else {
            button.disabled = false;
            button.classList.remove('loading');
            button.textContent = originalText;
        }
    }

    // Ẩn form hiện tại và hiển thị form mới
    function switchForm(formToShow, formToHide1, formToHide2) {
        [formToHide1, formToHide2].forEach(form => form.classList.add('hidden'));
        formToShow.classList.remove('hidden');
        messageBox.classList.add('hidden'); // Xóa thông báo cũ khi chuyển form
        // Đặt lại trạng thái của các trường input
        formToShow.querySelectorAll('input').forEach(input => input.value = '');
        [regEmailError, regPasswordError, regConfirmPasswordError].forEach(el => el.classList.add('hidden'));
    }

    // --- XỬ LÝ SỰ KIỆN CHUYỂN ĐỔI FORM ---
    showLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        switchForm(loginForm, registerForm, forgotPasswordForm);
    });

    showRegisterLink.addEventListener('click', (e) => {
        e.preventDefault();
        switchForm(registerForm, loginForm, forgotPasswordForm);
    });
    
    showForgotPasswordLink.addEventListener('click', (e) => {
        e.preventDefault();
        switchForm(forgotPasswordForm, registerForm, loginForm);
    });
    
    backToLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        switchForm(loginForm, registerForm, forgotPasswordForm);
    });
    
    // --- HÀM VALIDATION (KIỂM TRA DỮ LIỆU) ---
    function validateRegistrationForm() {
        let isValid = true;
        const email = regEmailInput.value;
        const password = regPasswordInput.value;
        const confirmPassword = regConfirmPasswordInput.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        // 1. Kiểm tra Email
        if (!emailRegex.test(email)) {
            regEmailError.classList.remove('hidden');
            isValid = false;
        } else {
            regEmailError.classList.add('hidden');
        }

        // 2. Kiểm tra Mật khẩu
        if (password.length < 6) {
            regPasswordError.classList.remove('hidden');
            isValid = false;
        } else {
            regPasswordError.classList.add('hidden');
        }

        // 3. Kiểm tra Xác nhận Mật khẩu
        if (password !== confirmPassword) {
            regConfirmPasswordError.classList.remove('hidden');
            isValid = false;
        } else {
            regConfirmPasswordError.classList.add('hidden');
        }

        return isValid;
    }
    
    // Bắt sự kiện gõ phím để ẩn lỗi (UX tốt hơn)
    [regEmailInput, regPasswordInput, regConfirmPasswordInput].forEach(input => {
        input.addEventListener('input', validateRegistrationForm);
    });


    // --- XỬ LÝ ĐĂNG KÝ (TÍCH HỢP FIREBASE AUTH) ---
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!validateRegistrationForm()) {
            showMessage("Vui lòng kiểm tra lại thông tin đăng ký.", 'error');
            return;
        }
        
        if (!isFirebaseReady) {
            showMessage("Lỗi: Firebase chưa được cấu hình. Chỉ có thể mô phỏng.", 'error');
            return;
        }
        
        const email = regEmailInput.value;
        const password = regPasswordInput.value;
        const originalText = registerButton.textContent;
        setLoading(registerButton, true, originalText);

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            console.log("Đăng ký thành công. User:", userCredential.user);
            
            showMessage(`Đăng ký tài khoản ${email} thành công! Tự động đăng nhập.`, 'success');
            
            // Xóa form và chuyển hướng đến trang chính (mô phỏng)
            document.getElementById('auth-container').innerHTML = `<div class="p-8 text-center text-gray-700"><h3 class="text-2xl font-semibold">Chào mừng ${email}!</h3><p class="mt-2">Bạn đã đăng nhập thành công. (UID: ${userCredential.user.uid})</p></div>`;

        } catch (error) {
            console.error("Lỗi Đăng ký Firebase:", error.code, error.message);
            let errorMessage = "Đăng ký thất bại. Vui lòng thử lại.";
            if (error.code === 'auth/email-already-in-use') {
                errorMessage = "Email này đã được sử dụng. Vui lòng chọn email khác hoặc Đăng nhập.";
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = "Email không hợp lệ.";
            }
            showMessage(errorMessage, 'error');
        } finally {
            setLoading(registerButton, false, originalText);
        }
    });

    // --- XỬ LÝ ĐĂNG NHẬP (TÍCH HỢP FIREBASE AUTH) ---
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!isFirebaseReady) {
            showMessage("Lỗi: Firebase chưa được cấu hình. Chỉ có thể mô phỏng.", 'error');
            return;
        }
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const originalText = loginButton.textContent;
        setLoading(loginButton, true, originalText);

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            console.log("Đăng nhập thành công. User:", userCredential.user);
            
            showMessage(`Đăng nhập thành công! Chào mừng trở lại.`, 'success');
            
            // Xóa form và chuyển hướng đến trang chính (mô phỏng)
            document.getElementById('auth-container').innerHTML = `<div class="p-8 text-center text-gray-700"><h3 class="text-2xl font-semibold">Chào mừng ${email}!</h3><p class="mt-2">Bạn đã đăng nhập thành công. (UID: ${userCredential.user.uid})</p></div>`;
            
        } catch (error) {
            console.error("Lỗi Đăng nhập Firebase:", error.code, error.message);
            let errorMessage = "Đăng nhập thất bại. Vui lòng kiểm tra lại Email và Mật khẩu.";
            if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                errorMessage = "Sai Email hoặc Mật khẩu. Vui lòng thử lại.";
            }
            showMessage(errorMessage, 'error');
        } finally {
            setLoading(loginButton, false, originalText);
        }
    });
    
    // --- XỬ LÝ QUÊN MẬT KHẨU (TÍCH HỢP FIREBASE AUTH) ---
    forgotPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!isFirebaseReady) {
            showMessage("Lỗi: Firebase chưa được cấu hình. Chỉ có thể mô phỏng.", 'error');
            return;
        }
        
        const email = resetEmailInput.value;
        if (!email) {
            showMessage("Vui lòng nhập địa chỉ email để đặt lại mật khẩu.", 'error');
            return;
        }
        
        const originalText = resetPasswordButton.textContent;
        setLoading(resetPasswordButton, true, originalText);

        try {
            await sendPasswordResetEmail(auth, email);
            console.log("Gửi email đặt lại mật khẩu thành công.");
            
            showMessage(`Chúng tôi đã gửi một email đặt lại mật khẩu tới ${email}. Vui lòng kiểm tra hộp thư của bạn!`, 'success');
            
            // Chuyển về form đăng nhập sau khi gửi thành công
            setTimeout(() => {
                switchForm(loginForm, registerForm, forgotPasswordForm);
            }, 3000);

        } catch (error) {
            console.error("Lỗi gửi email đặt lại mật khẩu:", error.code, error.message);
            let errorMessage = "Không thể gửi email đặt lại mật khẩu. Vui lòng thử lại.";
            if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                 // Firebase Auth cố tình trả về cùng một thông báo lỗi để tránh tiết lộ liệu email có tồn tại hay không.
                errorMessage = "Nếu email này đã đăng ký, chúng tôi sẽ gửi một liên kết đặt lại mật khẩu. Vui lòng kiểm tra hộp thư rác (spam).";
            }
            showMessage(errorMessage, 'error');
        } finally {
            setLoading(resetPasswordButton, false, originalText);
        }
    });

    // Đảm bảo chỉ có một form hiển thị ban đầu
    switchForm(registerForm, loginForm, forgotPasswordForm);

</script>
</body>
</html>